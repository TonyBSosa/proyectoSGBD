<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Insertar en {{ tabla }}</title>
</head>
<body>
    <h1>Insertar datos en la tabla: {{ tabla }}</h1>

    {% if mensaje %}
        <p><strong>{{ mensaje }}</strong></p>
    {% endif %}

    <form method="POST">
        {% for columna in columnas %}
            <label for="{{ columna }}">{{ columna }}:</label>
            <input type="text" name="{{ columna }}" id="{{ columna }}" required><br><br>
        {% endfor %}
        <button type="submit">Insertar</button>
    </form>

    <br>
    <a href="{{ url_for('seleccionar_tabla_insertar', motor=motor) }}">ğŸ”™ Volver a selecciÃ³n de tabla</a>

    {% if registros %}
        <h2>ğŸ“„ Registros actuales en la tabla "{{ tabla }}":</h2>
        <table border="1" cellpadding="5">
            <thead>
                <tr>
                    {% for col in columnas %}
                        <th>{{ col }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for fila in registros %}
                    <tr>
                     {% for i in range(fila|length) %}
    <td contenteditable="true"
        data-columna="{{ columnas[i] }}"
        data-idcolumna="{{ columnas[0] }}"
        data-idvalor="{{ fila[0] }}"
        onblur="guardarCambio(this)"
        onkeydown="if(event.key==='Enter'){event.preventDefault(); this.blur();}">
        {{ fila[i] }}
    </td>
{% endfor %}

                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}

    <script>
    function guardarCambio(td) {
        const motor = "{{ motor }}";
        const tabla = "{{ tabla }}";
        const columna = td.dataset.columna;
        const id_columna = td.dataset.idcolumna;
        const id_valor = td.dataset.idvalor;
        const valor = td.innerText;

        fetch("/actualizar-celda", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `motor=${motor}&tabla=${tabla}&columna=${columna}&id_columna=${id_columna}&id_valor=${id_valor}&valor=${encodeURIComponent(valor)}`
        })
        .then(res => res.json())
        .then(data => {
            if (data.status !== 'success') {
                alert("âŒ Error al actualizar: " + data.message);
            }
        });
    }
    </script>
</body>
</html>
